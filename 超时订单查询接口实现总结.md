# è¶…æ—¶è®¢å•æŸ¥è¯¢æ¥å£å®ç°æ€»ç»“

## é—®é¢˜æè¿°
OrderMapperæ¥å£ä¸­å®šä¹‰äº†`selectTimeoutUnpaidOrders`æ–¹æ³•ï¼Œä½†åœ¨OrderMapper.xmlä¸­ç¼ºå°‘å¯¹åº”çš„SQLå®ç°ã€‚

## è§£å†³æ–¹æ¡ˆ

### 1. å®Œå–„XMLæ˜ å°„å®ç°

#### 1.1 æ·»åŠ SQLæŸ¥è¯¢è¯­å¥
åœ¨`OrderMapper.xml`ä¸­æ·»åŠ äº†å®Œæ•´çš„æŸ¥è¯¢å®ç°ï¼š

```xml
<!-- æŸ¥è¯¢è¶…æ—¶æœªæ”¯ä»˜çš„è®¢å• -->
<select id="selectTimeoutUnpaidOrders" resultType="com.restaurant.order.entity.Order">
    SELECT 
        id,
        order_number,
        table_id,
        customer_id,
        status,
        total_amount,
        payment_status,
        payment_method,
        payment_time,
        estimated_time,
        completed_time,
        remark,
        cancel_reason,
        created_at,
        updated_at
    FROM orders 
    WHERE status = 'PENDING' 
    AND payment_status = 'UNPAID' 
    AND created_at < #{timeoutTime}
    AND deleted = 0
    ORDER BY created_at ASC
</select>
```

#### 1.2 æŸ¥è¯¢æ¡ä»¶è¯´æ˜
- **status = 'PENDING'**: åªæŸ¥è¯¢å¾…ç¡®è®¤çŠ¶æ€çš„è®¢å•
- **payment_status = 'UNPAID'**: åªæŸ¥è¯¢æœªæ”¯ä»˜çš„è®¢å•
- **created_at < #{timeoutTime}**: åˆ›å»ºæ—¶é—´æ—©äºæŒ‡å®šè¶…æ—¶æ—¶é—´
- **deleted = 0**: æ’é™¤å·²åˆ é™¤çš„è®¢å•
- **ORDER BY created_at ASC**: æŒ‰åˆ›å»ºæ—¶é—´å‡åºæ’åˆ—ï¼Œä¼˜å…ˆå¤„ç†æœ€æ—©çš„è®¢å•

### 2. æ–°å¢è®¢å•è¶…æ—¶å¤„ç†æœåŠ¡

#### 2.1 OrderTimeoutServiceæ¥å£
```java
public interface OrderTimeoutService {
    // è·å–è¶…æ—¶æœªæ”¯ä»˜çš„è®¢å•IDåˆ—è¡¨
    List<Long> getTimeoutUnpaidOrderIds(int timeoutMinutes);
    
    // æ‰¹é‡å¤„ç†è¶…æ—¶è®¢å•
    int processTimeoutOrders(int timeoutMinutes);
    
    // æ£€æŸ¥å¹¶å¤„ç†å•ä¸ªè®¢å•æ˜¯å¦è¶…æ—¶
    boolean checkAndProcessSingleOrderTimeout(Long orderId);
}
```

#### 2.2 OrderTimeoutServiceImplå®ç°
- **å®Œæ•´çš„æ—¥å¿—è®°å½•**: è¯¦ç»†è®°å½•å¤„ç†è¿‡ç¨‹
- **å¼‚å¸¸å¤„ç†**: å•ä¸ªè®¢å•å¤„ç†å¤±è´¥ä¸å½±å“å…¶ä»–è®¢å•
- **çµæ´»çš„è¶…æ—¶æ—¶é—´**: æ”¯æŒè‡ªå®šä¹‰è¶…æ—¶åˆ†é’Ÿæ•°
- **çŠ¶æ€éªŒè¯**: ç¡®ä¿åªå¤„ç†ç¬¦åˆæ¡ä»¶çš„è®¢å•

### 3. ä¼˜åŒ–å®šæ—¶ä»»åŠ¡

#### 3.1 PaymentTimeoutTaskå¢å¼º
```java
@Component
public class PaymentTimeoutTask {
    // æ”¯æŒé…ç½®åŒ–çš„è¶…æ—¶æ—¶é—´
    @Value("${order.payment.timeout.minutes:30}")
    private int paymentTimeoutMinutes;
    
    // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    @Scheduled(fixedRate = 60000)
    public void checkPaymentTimeout() { ... }
    
    // æ¯å°æ—¶æ·±åº¦æ£€æŸ¥ä¸€æ¬¡
    @Scheduled(fixedRate = 3600000)
    public void deepCheckPaymentTimeout() { ... }
}
```

#### 3.2 æ–°å¢åŠŸèƒ½
- **é…ç½®åŒ–è¶…æ—¶æ—¶é—´**: é€šè¿‡é…ç½®æ–‡ä»¶è®¾ç½®è¶…æ—¶æ—¶é—´
- **åŒé‡æ£€æŸ¥æœºåˆ¶**: å¸¸è§„æ£€æŸ¥ + æ·±åº¦æ£€æŸ¥
- **è¯¦ç»†çš„å¤„ç†ç»Ÿè®¡**: è®°å½•å¤„ç†çš„è®¢å•æ•°é‡

### 4. ç®¡ç†æ¥å£

#### 4.1 OrderTimeoutController
æä¾›HTTPæ¥å£ç”¨äºè¶…æ—¶è®¢å•ç®¡ç†ï¼š

```java
// æ‰‹åŠ¨è§¦å‘è¶…æ—¶è®¢å•å¤„ç†
POST /api/orders/timeout/process?timeoutMinutes=30

// è·å–è¶…æ—¶è®¢å•IDåˆ—è¡¨
GET /api/orders/timeout/list?timeoutMinutes=30

// æ£€æŸ¥å•ä¸ªè®¢å•æ˜¯å¦è¶…æ—¶
POST /api/orders/timeout/check/{orderId}
```

#### 4.2 æ¥å£åŠŸèƒ½
- **æ‰‹åŠ¨å¤„ç†**: æ”¯æŒè¿ç»´äººå‘˜æ‰‹åŠ¨è§¦å‘å¤„ç†
- **æŸ¥è¯¢åŠŸèƒ½**: æŸ¥çœ‹å½“å‰è¶…æ—¶è®¢å•æƒ…å†µ
- **å•è®¢å•æ£€æŸ¥**: é’ˆå¯¹ç‰¹å®šè®¢å•çš„è¶…æ—¶æ£€æŸ¥

### 5. æµ‹è¯•æ”¯æŒ

#### 5.1 OrderMapperTest
```java
@Test
public void testSelectTimeoutUnpaidOrders() {
    // åˆ›å»ºæµ‹è¯•æ•°æ®
    // éªŒè¯æŸ¥è¯¢ç»“æœ
    // ç¡®ä¿æŸ¥è¯¢æ¡ä»¶æ­£ç¡®
}
```

#### 5.2 æµ‹è¯•è¦†ç›–
- **æ­£å¸¸åœºæ™¯**: æœ‰è¶…æ—¶è®¢å•çš„æƒ…å†µ
- **è¾¹ç•Œåœºæ™¯**: æ²¡æœ‰è¶…æ—¶è®¢å•çš„æƒ…å†µ
- **æ•°æ®éªŒè¯**: ç¡®ä¿æŸ¥è¯¢ç»“æœå‡†ç¡®

### 6. é…ç½®æ”¯æŒ

#### 6.1 application.ymlé…ç½®
```yaml
order:
  payment:
    timeout:
      minutes: 30  # æ”¯ä»˜è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
```

#### 6.2 é…ç½®è¯´æ˜
- **çµæ´»é…ç½®**: æ”¯æŒä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒè¶…æ—¶æ—¶é—´
- **é»˜è®¤å€¼**: æä¾›åˆç†çš„é»˜è®¤å€¼ï¼ˆ30åˆ†é’Ÿï¼‰
- **è¿è¡Œæ—¶è°ƒæ•´**: æ”¯æŒé€šè¿‡æ¥å£å‚æ•°ä¸´æ—¶è°ƒæ•´

## æŠ€æœ¯ç‰¹ç‚¹

### 1. æ€§èƒ½ä¼˜åŒ–
- **ç´¢å¼•å‹å¥½**: æŸ¥è¯¢æ¡ä»¶é€‚åˆå»ºç«‹å¤åˆç´¢å¼•
- **åˆ†é¡µæ”¯æŒ**: å¯æ‰©å±•æ”¯æŒå¤§é‡æ•°æ®çš„åˆ†é¡µå¤„ç†
- **æ‰¹é‡å¤„ç†**: ä¸€æ¬¡æ€§å¤„ç†å¤šä¸ªè¶…æ—¶è®¢å•

### 2. å¯é æ€§ä¿éšœ
- **äº‹åŠ¡å®‰å…¨**: æ¯ä¸ªè®¢å•çš„å¤„ç†éƒ½åœ¨ç‹¬ç«‹äº‹åŠ¡ä¸­
- **å¼‚å¸¸éš”ç¦»**: å•ä¸ªè®¢å•å¤±è´¥ä¸å½±å“å…¶ä»–è®¢å•
- **é‡è¯•æœºåˆ¶**: æ·±åº¦æ£€æŸ¥æä¾›äºŒæ¬¡å¤„ç†æœºä¼š

### 3. ç›‘æ§å‹å¥½
- **è¯¦ç»†æ—¥å¿—**: å®Œæ•´çš„æ“ä½œæ—¥å¿—ä¾¿äºé—®é¢˜æ’æŸ¥
- **ç»Ÿè®¡ä¿¡æ¯**: æä¾›å¤„ç†æ•°é‡ç­‰ç»Ÿè®¡æ•°æ®
- **çŠ¶æ€è¿½è¸ª**: è®°å½•æ¯ä¸ªè®¢å•çš„å¤„ç†çŠ¶æ€

### 4. æ‰©å±•æ€§
- **æœåŠ¡åˆ†ç¦»**: è¶…æ—¶å¤„ç†é€»è¾‘ç‹¬ç«‹æˆæœåŠ¡
- **æ¥å£æ ‡å‡†**: æä¾›æ ‡å‡†çš„HTTPç®¡ç†æ¥å£
- **é…ç½®çµæ´»**: æ”¯æŒå¤šç§é…ç½®æ–¹å¼

## ä½¿ç”¨ç¤ºä¾‹

### 1. è‡ªåŠ¨å¤„ç†
```java
// å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ‰§è¡Œ
// æ¯åˆ†é’Ÿæ£€æŸ¥30åˆ†é’Ÿå‰çš„è¶…æ—¶è®¢å•
// æ¯å°æ—¶æ·±åº¦æ£€æŸ¥60åˆ†é’Ÿå‰çš„è¶…æ—¶è®¢å•
```

### 2. æ‰‹åŠ¨å¤„ç†
```bash
# æ‰‹åŠ¨å¤„ç†30åˆ†é’Ÿå‰çš„è¶…æ—¶è®¢å•
curl -X POST "http://localhost:8080/api/orders/timeout/process?timeoutMinutes=30"

# æŸ¥çœ‹å½“å‰è¶…æ—¶è®¢å•
curl -X GET "http://localhost:8080/api/orders/timeout/list?timeoutMinutes=30"
```

### 3. å•è®¢å•æ£€æŸ¥
```bash
# æ£€æŸ¥ç‰¹å®šè®¢å•æ˜¯å¦è¶…æ—¶
curl -X POST "http://localhost:8080/api/orders/timeout/check/123"
```

## æ€»ç»“

é€šè¿‡æœ¬æ¬¡å®Œå–„ï¼Œè¶…æ—¶è®¢å•æŸ¥è¯¢å’Œå¤„ç†åŠŸèƒ½ç°åœ¨å…·å¤‡äº†ï¼š

âœ… **å®Œæ•´çš„SQLå®ç°** - è§£å†³äº†XMLæ˜ å°„ç¼ºå¤±é—®é¢˜
âœ… **ä¸“ä¸šçš„æœåŠ¡å±‚** - ç‹¬ç«‹çš„è¶…æ—¶å¤„ç†æœåŠ¡
âœ… **æ™ºèƒ½çš„å®šæ—¶ä»»åŠ¡** - åŒé‡æ£€æŸ¥æœºåˆ¶
âœ… **ä¾¿æ·çš„ç®¡ç†æ¥å£** - HTTPæ¥å£æ”¯æŒæ‰‹åŠ¨æ“ä½œ
âœ… **å…¨é¢çš„æµ‹è¯•è¦†ç›–** - ç¡®ä¿åŠŸèƒ½æ­£ç¡®æ€§
âœ… **çµæ´»çš„é…ç½®æ”¯æŒ** - é€‚åº”ä¸åŒç¯å¢ƒéœ€æ±‚
âœ… **ä¼˜ç§€çš„å¯è§‚æµ‹æ€§** - è¯¦ç»†çš„æ—¥å¿—å’Œç»Ÿè®¡

ç°åœ¨ç³»ç»Ÿå¯ä»¥è‡ªåŠ¨ã€å¯é åœ°å¤„ç†æ”¯ä»˜è¶…æ—¶è®¢å•ï¼Œç¡®ä¿èµ„æºå¾—åˆ°åŠæ—¶é‡Šæ”¾ï¼ğŸ‰